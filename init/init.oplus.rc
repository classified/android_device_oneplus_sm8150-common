#
# Copyright (C) 2022 The LineageOS Project
#
# SPDX-License-Identifier: Apache-2.0
#

on fs
    # Charger
    write /proc/fastchg_fw_update 1
    write /proc/ui_soc_decimal 1

    # Update touchpanel firmware in case we ship newer firmware in /odm
    write /proc/touchpanel/tp_fw_update 0

on early-boot
    # Radio
    exec_start oplus-sh
    setprop persist.radio.multisim.config ${vendor.radio.multisim.config}

    # SSR
    write /sys/bus/msm_subsys/devices/subsys0/restart_level RELATED
    write /sys/bus/msm_subsys/devices/subsys1/restart_level RELATED
    write /sys/bus/msm_subsys/devices/subsys2/restart_level RELATED
    write /sys/bus/msm_subsys/devices/subsys3/restart_level RELATED
    write /sys/bus/msm_subsys/devices/subsys4/restart_level RELATED
    write /sys/bus/msm_subsys/devices/subsys5/restart_level RELATED
    write /sys/bus/msm_subsys/devices/subsys6/restart_level RELATED
    write /sys/bus/msm_subsys/devices/subsys7/restart_level RELATED
    write /sys/bus/msm_subsys/devices/subsys8/restart_level RELATED

on post-fs-data
    # Disable zram readahead
    write /proc/sys/vm/page-cluster 0
    # Override readahead to 2MiB during boot
    write /sys/block/dm-0/queue/read_ahead_kb 2048
    write /sys/block/dm-1/queue/read_ahead_kb 2048
    write /sys/block/dm-2/queue/read_ahead_kb 2048
    write /sys/block/dm-3/queue/read_ahead_kb 2048
    write /sys/block/dm-4/queue/read_ahead_kb 2048
    write /sys/block/dm-5/queue/read_ahead_kb 2048
    write /sys/block/dm-6/queue/read_ahead_kb 2048
    write /sys/block/dm-7/queue/read_ahead_kb 2048
    write /sys/block/dm-8/queue/read_ahead_kb 2048
    write /sys/block/dm-9/queue/read_ahead_kb 2048
    write /sys/block/mmcblk0/queue/read_ahead_kb 2048
    write /sys/block/sda/queue/read_ahead_kb 2048
    write /sys/block/sdb/queue/read_ahead_kb 2048
    write /sys/block/sdc/queue/read_ahead_kb 2048
    write /sys/block/sdd/queue/read_ahead_kb 2048
    write /sys/block/sde/queue/read_ahead_kb 2048
    write /sys/block/sdf/queue/read_ahead_kb 2048

on early-init
    # Increase readahead to 2MiB.
    write /sys/block/dm-0/queue/read_ahead_kb 2048
    write /sys/block/dm-1/queue/read_ahead_kb 2048
    write /sys/block/dm-2/queue/read_ahead_kb 2048
    write /sys/block/dm-3/queue/read_ahead_kb 2048
    write /sys/block/dm-4/queue/read_ahead_kb 2048
    write /sys/block/dm-5/queue/read_ahead_kb 2048
    write /sys/block/dm-6/queue/read_ahead_kb 2048
    write /sys/block/dm-7/queue/read_ahead_kb 2048
    write /sys/block/dm-8/queue/read_ahead_kb 2048
    write /sys/block/dm-9/queue/read_ahead_kb 2048
    write /sys/block/mmcblk0/queue/read_ahead_kb 2048
    write /sys/block/sda/queue/read_ahead_kb 2048
    write /sys/block/sdb/queue/read_ahead_kb 2048
    write /sys/block/sdc/queue/read_ahead_kb 2048
    write /sys/block/sdd/queue/read_ahead_kb 2048
    write /sys/block/sde/queue/read_ahead_kb 2048
    write /sys/block/sdf/queue/read_ahead_kb 2048

    # Increase maximum number of I/O requests.
    write /sys/block/dm-0/queue/nr_requests 256
    write /sys/block/dm-1/queue/nr_requests 256
    write /sys/block/dm-2/queue/nr_requests 256
    write /sys/block/dm-3/queue/nr_requests 256
    write /sys/block/dm-4/queue/nr_requests 256
    write /sys/block/dm-5/queue/nr_requests 256
    write /sys/block/dm-6/queue/nr_requests 256
    write /sys/block/dm-7/queue/nr_requests 256
    write /sys/block/dm-8/queue/nr_requests 256
    write /sys/block/dm-9/queue/nr_requests 256
    write /sys/block/mmcblk0/queue/nr_requests 256
    write /sys/block/sda/queue/nr_requests 256
    write /sys/block/sdb/queue/nr_requests 256
    write /sys/block/sdc/queue/nr_requests 256
    write /sys/block/sdd/queue/nr_requests 256
    write /sys/block/sde/queue/nr_requests 256
    write /sys/block/sdf/queue/nr_requests 256

    # Disable I/O stats.
    write /sys/block/dm-0/queue/iostats 0
    write /sys/block/dm-1/queue/iostats 0
    write /sys/block/dm-2/queue/iostats 0
    write /sys/block/dm-3/queue/iostats 0
    write /sys/block/dm-4/queue/iostats 0
    write /sys/block/dm-5/queue/iostats 0
    write /sys/block/dm-6/queue/iostats 0
    write /sys/block/dm-7/queue/iostats 0
    write /sys/block/dm-8/queue/iostats 0
    write /sys/block/dm-9/queue/iostats 0
    write /sys/block/mmcblk0/queue/iostats 0
    write /sys/block/sda/queue/iostats 0
    write /sys/block/sdb/queue/iostats 0
    write /sys/block/sdc/queue/iostats 0
    write /sys/block/sdd/queue/iostats 0
    write /sys/block/sde/queue/iostats 0
    write /sys/block/sdf/queue/iostats 0

on property:sys.boot_completed=1
    # Reset maximum I/O requests for runtime.
    write /sys/block/dm-0/queue/nr_requests 128
    write /sys/block/dm-1/queue/nr_requests 128
    write /sys/block/dm-2/queue/nr_requests 128
    write /sys/block/dm-3/queue/nr_requests 128
    write /sys/block/dm-4/queue/nr_requests 128
    write /sys/block/dm-5/queue/nr_requests 128
    write /sys/block/dm-6/queue/nr_requests 128
    write /sys/block/dm-7/queue/nr_requests 128
    write /sys/block/dm-8/queue/nr_requests 128
    write /sys/block/dm-9/queue/nr_requests 128
    write /sys/block/mmcblk0/queue/nr_requests 128
    write /sys/block/sda/queue/nr_requests 128
    write /sys/block/sdb/queue/nr_requests 128
    write /sys/block/sdc/queue/nr_requests 128
    write /sys/block/sdd/queue/nr_requests 128
    write /sys/block/sde/queue/nr_requests 128
    write /sys/block/sdf/queue/nr_requests 128

on property:vendor.post_boot.parsed=1
    # Set cpuset audio-app
    write /dev/cpuset/audio-app/cpus 1-2
    # Set restricted cpuset to the same CPUs as system-background
    copy /dev/cpuset/system-background/cpus /dev/cpuset/restricted/cpus
    # Reset readahead to 128KiB
    write /sys/block/dm-0/queue/read_ahead_kb 128
    write /sys/block/dm-1/queue/read_ahead_kb 128
    write /sys/block/dm-2/queue/read_ahead_kb 128
    write /sys/block/dm-3/queue/read_ahead_kb 128
    write /sys/block/dm-4/queue/read_ahead_kb 128
    write /sys/block/dm-5/queue/read_ahead_kb 128
    write /sys/block/dm-6/queue/read_ahead_kb 128
    write /sys/block/dm-7/queue/read_ahead_kb 128
    write /sys/block/dm-8/queue/read_ahead_kb 128
    write /sys/block/dm-9/queue/read_ahead_kb 128
    write /sys/block/dm-10/queue/read_ahead_kb 128
    write /sys/block/dm-11/queue/read_ahead_kb 128
    write /sys/block/dm-12/queue/read_ahead_kb 128
    write /sys/block/dm-13/queue/read_ahead_kb 128
    write /sys/block/dm-14/queue/read_ahead_kb 128
    write /sys/block/dm-15/queue/read_ahead_kb 128
    write /sys/block/dm-16/queue/read_ahead_kb 128
    write /sys/block/dm-17/queue/read_ahead_kb 128
    write /sys/block/dm-18/queue/read_ahead_kb 128
    write /sys/block/dm-19/queue/read_ahead_kb 128
    write /sys/block/dm-20/queue/read_ahead_kb 128
    write /sys/block/dm-21/queue/read_ahead_kb 128
    write /sys/block/dm-22/queue/read_ahead_kb 128
    write /sys/block/dm-23/queue/read_ahead_kb 128
    write /sys/block/dm-24/queue/read_ahead_kb 128
    write /sys/block/dm-25/queue/read_ahead_kb 128
    write /sys/block/dm-26/queue/read_ahead_kb 128
    write /sys/block/dm-27/queue/read_ahead_kb 128
    write /sys/block/dm-28/queue/read_ahead_kb 128
    write /sys/block/dm-29/queue/read_ahead_kb 128
    write /sys/block/dm-30/queue/read_ahead_kb 128
    write /sys/block/dm-31/queue/read_ahead_kb 128
    write /sys/block/dm-32/queue/read_ahead_kb 128
    write /sys/block/dm-33/queue/read_ahead_kb 128
    write /sys/block/dm-34/queue/read_ahead_kb 128
    write /sys/block/dm-35/queue/read_ahead_kb 128
    write /sys/block/dm-36/queue/read_ahead_kb 128
    write /sys/block/dm-37/queue/read_ahead_kb 128
    write /sys/block/dm-38/queue/read_ahead_kb 128
    write /sys/block/dm-39/queue/read_ahead_kb 128
    write /sys/block/dm-40/queue/read_ahead_kb 128
    write /sys/block/dm-41/queue/read_ahead_kb 128
    write /sys/block/dm-42/queue/read_ahead_kb 128
    write /sys/block/dm-43/queue/read_ahead_kb 128
    write /sys/block/dm-44/queue/read_ahead_kb 128
    write /sys/block/dm-45/queue/read_ahead_kb 128
    write /sys/block/dm-46/queue/read_ahead_kb 128
    write /sys/block/dm-47/queue/read_ahead_kb 128
    write /sys/block/dm-48/queue/read_ahead_kb 128
    write /sys/block/dm-49/queue/read_ahead_kb 128
    write /sys/block/mmcblk0/queue/read_ahead_kb 128
    write /sys/block/sda/queue/read_ahead_kb 128
    write /sys/block/sdb/queue/read_ahead_kb 128
    write /sys/block/sdc/queue/read_ahead_kb 128
    write /sys/block/sdd/queue/read_ahead_kb 128
    write /sys/block/sde/queue/read_ahead_kb 128
    write /sys/block/sdf/queue/read_ahead_kb 128

on property:ro.board.platform=msmnile && property:vendor.post_boot.parsed=1
    # Setup foreground cpuset for display composer.
    write /dev/cpuset/foreground/cpus 0-6

    # CPUFreq
    write /sys/devices/system/cpu/cpufreq/policy0/schedutil/up_rate_limit_us 500
    write /sys/devices/system/cpu/cpufreq/policy0/schedutil/down_rate_limit_us 20000
    write /sys/devices/system/cpu/cpufreq/policy4/schedutil/up_rate_limit_us 500
    write /sys/devices/system/cpu/cpufreq/policy4/schedutil/down_rate_limit_us 20000
    write /sys/devices/system/cpu/cpufreq/policy7/schedutil/up_rate_limit_us 500
    write /sys/devices/system/cpu/cpufreq/policy7/schedutil/down_rate_limit_us 20000

on boot
    # Display
    chown system system /dev/oplus_display
    chown system system /sys/kernel/oplus_display/dimlayer_bl_en
    chown system system /sys/kernel/oplus_display/dynamic_osc_clock
    chown system system /sys/kernel/oplus_display/hbm
    chown system system /sys/kernel/oplus_display/notify_fppress
    chown system system /sys/kernel/oplus_display/panel_serial_number

    # Motor
    chown system system /sys/class/motor/direction
    chown system system /sys/class/motor/enable
    chown system system /sys/class/motor/hall_calibration
    chown system system /sys/class/motor/position

    # Sensors
    chown system system /sys/devices/platform/soc/soc:sensor_fb/adsp_notify

    # TOF
    chown cameraserver cameraserver /dev/stmvl53l1_ranging

    # Ultrasound
    chmod 0666 /dev/audio_ultrasound
    chmod 0666 /dev/sensor_ultrasound

on property:ro.boot.prjname=*
    # Display
    setprop ro.separate.soft ${ro.boot.prjname}

on property:sys.boot_completed=1
    # Display
    copy /vendor/etc/Oppo_QC_LTM_Commercial_SM8250_2020_01_15.pfm /mnt/vendor/persist/data/pfm/licenses/1000-1000-no-exp-1186717196.pfm
    chown system system /mnt/vendor/persist/data/pfm/licenses/1000-1000-no-exp-1186717196.pfm

on property:sys.usb.config=adb && property:sys.usb.configfs=1
    write /config/usb_gadget/g1/idVendor 0x22D9
    write /config/usb_gadget/g1/idProduct 0x2769

on property:sys.usb.config=mass_storage && property:sys.usb.configfs=1
    write /config/usb_gadget/g1/idProduct 0x2768
    write /config/usb_gadget/g1/idVendor 0x22D9

on property:sys.usb.config=mtp && property:sys.usb.configfs=1
    write /config/usb_gadget/g1/idVendor 0x22D9
    write /config/usb_gadget/g1/idProduct 0x2764

on property:sys.usb.config=mtp,adb && property:sys.usb.configfs=1
    write /config/usb_gadget/g1/idVendor 0x22D9
    write /config/usb_gadget/g1/idProduct 0x2765

on property:sys.usb.config=ptp && property:sys.usb.configfs=1
    write /config/usb_gadget/g1/idVendor 0x22D9
    write /config/usb_gadget/g1/idProduct 0x2771

on property:sys.usb.config=ptp,adb && property:sys.usb.configfs=1
    write /config/usb_gadget/g1/idVendor 0x22D9
    write /config/usb_gadget/g1/idProduct 0x2772

on property:sys.usb.config=rndis,none && property:sys.usb.configfs=1
    write /config/usb_gadget/g1/idVendor 0x22D9
    write /config/usb_gadget/g1/idProduct 0x276A

on property:sys.usb.config=rndis,serial_cdev,diag && property:sys.usb.configfs=1
    write /config/usb_gadget/g1/idVendor 0x22D9
    write /config/usb_gadget/g1/idProduct 0x2783

on property:sys.usb.ffs.ready=1 && property:sys.usb.config=diag,adb && property:sys.usb.configfs=1
    write /config/usb_gadget/g1/idVendor 0x22D9
    write /config/usb_gadget/g1/idProduct 0x276C

on property:sys.usb.ffs.ready=1 && property:sys.usb.config=diag,diag_mdm,adb && property:sys.usb.configfs=1
    write /config/usb_gadget/g1/idVendor 0x22D9
    write /config/usb_gadget/g1/idProduct 0x276E

on property:sys.usb.ffs.ready=1 && property:sys.usb.config=mass_storage,adb && property:sys.usb.configfs=1
    write /config/usb_gadget/g1/idVendor 0x22D9
    write /config/usb_gadget/g1/idProduct 0x2767

on property:sys.usb.ffs.ready=1 && property:sys.usb.config=rndis,diag,adb && property:sys.usb.configfs=1
    write /config/usb_gadget/g1/idVendor 0x22D9
    write /config/usb_gadget/g1/idProduct 0x2775

on property:sys.usb.ffs.ready=1 && property:sys.usb.config=rndis,none,adb && property:sys.usb.configfs=1
    write /config/usb_gadget/g1/idVendor 0x22D9
    write /config/usb_gadget/g1/idProduct 0x2766

service oplus-sh /odm/bin/init.oplus.sh
    user root
    group root
    oneshot

service oplus-wifi-sh /odm/bin/init.oplus.wifi.sh
    class core
    user root
    oneshot

service oplus_sensor_fb /odm/bin/oplus_sensor_fb
    user system
    group system
    class late_start
    oneshot

service vl53l1_daemon_main /odm/bin/vl53l1_daemon_main
    class late_start
    user root
    group root
    socket vl53l1_daemon stream 660 root system
